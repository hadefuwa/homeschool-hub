<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fraction Chef: Challenge Mode</title>
    <style>
        :root {
            --bg: #2c3e50; --card: #ffffff; --green: #27ae60; --red: #e74c3c;
        }
        body { 
            background: var(--bg); font-family: 'Segoe UI', sans-serif; 
            margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh;
        }
        #game-window {
            background: #f8f9fa; width: 500px; border-radius: 40px; padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4); text-align: center; border: 8px solid #34495e;
            position: relative;
        }
        .header { display: flex; justify-content: space-between; font-weight: 800; color: #7f8c8d; }
        
        /* Fraction Styling */
        .fraction { margin: 15px 0; display: inline-block; font-size: 60px; font-weight: 900; color: #2c3e50; }
        .bar { height: 6px; background: #2c3e50; width: 80px; border-radius: 3px; margin: 2px auto; }

        /* Pizza Display */
        #pizza-svg { width: 280px; height: 280px; margin: 10px auto; }
        .slice { 
            fill: #f1c40f; stroke: #e67e22; stroke-width: 1.5; cursor: pointer;
            transition: 0.2s; transform-origin: center;
        }
        /* Visual feedback for selected slices */
        .selected { fill: #ffeb3b; stroke: #d35400; filter: drop-shadow(0 0 8px #f1c40f); transform: scale(1.05); }

        /* Buttons */
        .controls { margin-top: 20px; display: flex; gap: 10px; justify-content: center; }
        .btn { 
            padding: 15px 30px; font-size: 1.1rem; border-radius: 12px; border: none;
            cursor: pointer; font-weight: bold; color: white; transition: 0.2s;
        }
        #serve-btn { background: var(--green); box-shadow: 0 5px 0 #1e8449; }
        #clear-btn { background: #95a5a6; box-shadow: 0 5px 0 #7f8c8d; }
        .btn:active { transform: translateY(3px); box-shadow: none; }

        /* Overlay */
        #overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; border-radius: 32px; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 100;
        }
    </style>
</head>
<body>

<div id="game-window">
    <div class="header">
        <span>ROUND: <span id="r-val">1/5</span></span>
        <span>STARS: <span id="s-val">0</span></span>
    </div>

    <div class="fraction">
        <div id="num">1</div>
        <div class="bar"></div>
        <div id="den">4</div>
    </div>

    <div id="pizza-box">
        <svg viewBox="0 0 100 100" id="pizza-svg">
            <circle cx="50" cy="50" r="48" fill="#d35400" />
            <circle cx="50" cy="50" r="43" fill="#f39c12" />
            <g id="slice-group"></g>
        </svg>
    </div>

    <div id="msg" style="font-weight: bold; min-height: 25px; margin: 10px;">Pick the slices!</div>

    <div class="controls">
        <button id="clear-btn" class="btn" onclick="clearPizza()">Reset</button>
        <button id="serve-btn" class="btn" onclick="checkAnswer()">Serve Pizza!</button>
    </div>

    <div id="overlay">
        <h1 id="medal-emoji" style="font-size: 80px; margin: 0;">ðŸ¥‡</h1>
        <h2 id="medal-name">GOLD MEDAL</h2>
        <p id="final-score">Score: 0</p>
        <button class="btn" style="background:#3498db" onclick="location.reload()">Play Again</button>
    </div>
</div>

<script>
    // Get difficulty level from URL parameter (default to 1)
    let level = 1;
    try {
        const urlParams = new URLSearchParams(window.location.search);
        level = parseInt(urlParams.get('level')) || 1;
        console.log('Fractions game loaded with level:', level, 'URL:', window.location.href);
    } catch (e) {
        console.error('Error parsing level:', e);
        level = 1;
    }
    
    // Configure difficulty settings based on level
    const levelConfig = {
        1: { denoms: [2], rounds: 3, title: "Halves Only" },
        2: { denoms: [2, 4], rounds: 4, title: "Halves & Quarters" },
        3: { denoms: [2, 3], rounds: 4, title: "Halves & Thirds" },
        4: { denoms: [2, 3, 4], rounds: 5, title: "Mixed Basics" },
        5: { denoms: [2, 4, 6], rounds: 5, title: "Sixths Intro" },
        6: { denoms: [3, 6], rounds: 5, title: "Thirds & Sixths" },
        7: { denoms: [2, 4, 8], rounds: 5, title: "Eighths Challenge" },
        8: { denoms: [2, 3, 4, 6], rounds: 6, title: "Advanced Mix" },
        9: { denoms: [4, 6, 8], rounds: 6, title: "Complex Fractions" },
        10: { denoms: [2, 3, 4, 6, 8, 12], rounds: 7, title: "Master Chef" }
    };
    
    const config = levelConfig[level] || levelConfig[1];
    const totalRounds = config.rounds;
    document.title = `Fraction Chef: ${config.title}`;
    
    console.log('Using config:', config);
    
    let round = 1, stars = 0, targetN, targetD;

    function initRound() {
        if (round > totalRounds) return showEnd();
        document.getElementById('r-val').innerText = `${round}/${totalRounds}`;
        const denoms = config.denoms;
        targetD = denoms[Math.floor(Math.random() * denoms.length)];
        targetN = Math.floor(Math.random() * (targetD - 1)) + 1; // Ensure not improper fraction
        
        document.getElementById('num').innerText = targetN;
        document.getElementById('den').innerText = targetD;
        document.getElementById('msg').innerText = "Pick the slices!";
        document.getElementById('msg').style.color = "#34495e";
        
        drawSlices(targetD);
    }

    function drawSlices(n) {
        const group = document.getElementById('slice-group');
        group.innerHTML = '';
        const radius = 43, center = 50;

        for (let i = 0; i < n; i++) {
            const start = (i * 360) / n;
            const end = ((i + 1) * 360) / n;
            const x1 = center + radius * Math.cos(Math.PI * (start - 90) / 180);
            const y1 = center + radius * Math.sin(Math.PI * (start - 90) / 180);
            const x2 = center + radius * Math.cos(Math.PI * (end - 90) / 180);
            const y2 = center + radius * Math.sin(Math.PI * (end - 90) / 180);

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", `M 50 50 L ${x1} ${y1} A ${radius} ${radius} 0 0 1 ${x2} ${y2} Z`);
            path.classList.add("slice");
            path.onclick = () => path.classList.toggle('selected');
            group.appendChild(path);
        }
    }

    function clearPizza() {
        document.querySelectorAll('.slice').forEach(s => s.classList.remove('selected'));
    }

    function checkAnswer() {
        const selectedCount = document.querySelectorAll('.selected').length;
        const msg = document.getElementById('msg');

        if (selectedCount === targetN) {
            stars += 20;
            msg.innerText = "âœ… Correct! Great counting!";
            msg.style.color = "var(--green)";
            setTimeout(() => { round++; initRound(); document.getElementById('s-val').innerText = stars; }, 1200);
        } else {
            stars = Math.max(0, stars - 5); // Penalty
            document.getElementById('s-val').innerText = stars;
            msg.innerText = `âŒ Oops! That was ${selectedCount}/${targetD}. Try again!`;
            msg.style.color = "var(--red)";
            // Add a little shake animation
            document.getElementById('game-window').animate([
                { transform: 'translateX(0)' }, { transform: 'translateX(-10px)' }, { transform: 'translateX(10px)' }, { transform: 'translateX(0)' }
            ], { duration: 300 });
        }
    }

    function showEnd() {
        const overlay = document.getElementById('overlay');
        overlay.style.display = 'flex';
        const medal = document.getElementById('medal-emoji');
        if (stars >= 100) { medal.innerText = "ðŸ’Ž"; document.getElementById('medal-name').innerText = "PLATINUM"; }
        else if (stars >= 80) { medal.innerText = "ðŸ¥‡"; document.getElementById('medal-name').innerText = "GOLD"; }
        else if (stars >= 60) { medal.innerText = "ðŸ¥ˆ"; document.getElementById('medal-name').innerText = "SILVER"; }
        else { medal.innerText = "ðŸ¥‰"; document.getElementById('medal-name').innerText = "BRONZE"; }
        document.getElementById('final-score').innerText = `Final Stars: ${stars}`;
        
        // Notify parent app that game is complete
        if (window.parent) {
            window.parent.postMessage({ type: 'html-game-complete', game: 'fractions', score: stars }, '*');
        }
    }

    initRound();
</script>
</body>
</html>